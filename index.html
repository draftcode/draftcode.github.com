<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>draftcode.github.io</title>
    <meta name="author" content="draftcode">
    <meta name="google-site-verification" content="YjRoDozMq67s3NKiyM6spjwqnSVihlZ11ur-OgfZCU0">

    <!--[if lt IE 9]>
    <script src="./theme/html5.js"></script>
    <![endif]-->

    <link href="./theme/bootstrap.min.css" rel="stylesheet">
    <link href="./theme/local.css" rel="stylesheet">
    <link href="./theme/pygments.css" rel="stylesheet">
    <link rel="alternate" type="application/atom+xml" title="Atom" href="./atom.xml">
    <link href='http://fonts.googleapis.com/css?family=Economica' rel='stylesheet'>
</head>

<body>

<h1 id="site-title"><a href=".">draftcode.github.io</a></h1>

<div id="content">


    <div class='article'>
        <div class="content-title">
            <h1><a href="./2013/03/22/278e1973-0066-4749-8097-3a7dec906e0e.html">PythonのC拡張を書く</a></h1>
            <div class="metadata">
    <span class="label label-inverse">2013/03/22</span>
    <a href="./category/python.html" class="label label-info">Python</a>
</div>        </div>

        <div class="content-body"><p>最近はPythonのC拡張を書いていたりするので、覚えている範囲でハマった点を説明します。C拡張を書き始めるには、基本的に<a class="reference external" href="http://docs.python.jp/2/extending/index.html">Python インタプリタの拡張と埋め込み</a>をみて、あとは見よう見まねで書きながら<a class="reference external" href="http://docs.python.jp/2/c-api/index.html">Python/C API リファレンスマニュアル</a>を見とけばOKです。</p>
<div class="section" id="id1">
<h2>やると良いこと・ハマったこと</h2>
<div class="section" id="decref">
<h3>引数はDECREFしてはいけない</h3>
<p>Pythonのドキュメントをよく読んでないのも悪いのですが、どうやらPythonからCで書かれた関数を呼びだされたときに渡ってくる引数はDECREFしてはいけないようです。
Python組み込みのAPI用意している分にはドキュメントにNew Referenceとか書いてあるのでそれをみて判断すればいいです。</p>
</div>
<div class="section" id="decref2">
<h3>DECREFの引数は2回以上評価される可能性のあるマクロなので変数のみ渡す</h3>
<p>同じくDECREF周りですが、Py_DECREFとかはマクロなので引数が複数回評価される可能性があります。というかされます。なので<tt class="docutils literal"><span class="pre">Py_DECREF(PyObject_CallFunction(...))</span></tt>みたいなことをすると死にます。</p>
</div>
<div class="section" id="cpython">
<h3>cpythonのソースコードは手元に持っておく</h3>
<p>正直ドキュメントを参照するよりかはソースコード直接読んだほうが早かったりするので、cpythonのソースコードは手元においておきましょう。というかPythonのスクリプトを書いててもドキュメントに書いてない感じのこととか、曖昧な感じがする点があったりして、そういうときにソースコード手元に持っておくとすぐ確認できて便利です。</p>
</div>
<div class="section" id="id2">
<h3>デバッグ版Pythonを使う</h3>
<p>多分これは自分が高速化のために文字列の可変長配列を自分で持っていたりとか、そういうことをしているからだと思いますが、メモリ周りのエラーで苦しみました。ひたすらSegmentation Faultします。デバッグ版のPythonを使うとメモリまわりでチェックが走るのである程度メモリエラーを検出できます。Pythonは自前でメモリ割り当てを行なっている関係なのか、Valgrindとかを使ってもあんまりInvalid writeみたいなのは検出できなかったです。(Valgrindの仕組みとかよくわかってない)</p>
<p>デバッグ版Pythonのビルドの仕方は<a class="reference external" href="http://docs.python.org/devguide/">Python Developer's Guide</a>に書いてあるのでこれを見て<tt class="docutils literal"><span class="pre">--with-pydebug</span></tt>をつければOKです。自分は<a class="reference external" href="https://github.com/yyuu/pyenv">pyenv</a>を使っているので、そのプラグインの python-build を改造してデバッグ版ビルドができるようにしました。そのうち整理してPull-Request投げてみるかも。</p>
</div>
<div class="section" id="yep">
<h3>yepをつかってプロファイリング</h3>
<p><a class="reference external" href="https://pypi.python.org/pypi/yep">yep</a>はバックエンドで<a class="reference external" href="https://code.google.com/p/gperftools/">gperftools</a>を使ってプロファイリングをしてくれるモジュールです。普通にPython付属のプロファイラだとPythonのコードしかプロファイリングできないので、このモジュールを使ってどこが遅くなっているのかを調べます。</p>
</div>
</div>
<div class="section" id="id4">
<h2>よくわかってないこと</h2>
<div class="section" id="gc">
<h3>GC周り</h3>
<p>どうやらオブジェクト内に外のオブジェクトを含み場合は、普通はGCを有効にしなければいけない感じのようなのですが、別に自分が書いているクラスはユニコード文字列とファイルライクオブジェクトなので、GC周りのフラグを立てていません。GC-awareな書き方は、多分ドキュメント見ればわかるんだろうと思いつつ、よくわかってません。</p>
</div>
</div>
</div>
        <hr />
    </div>



    <div class='article'>
        <div class="content-title">
            <h1><a href="./2013/03/17/5f45fabb-8b64-469e-a0f6-7f9d76564af8.html">Windows環境でPythonのC拡張をビルドする</a></h1>
            <div class="metadata">
    <span class="label label-inverse">2013/03/17</span>
    <a href="./category/python.html" class="label label-info">Python</a>
</div>        </div>

        <div class="content-body"><p>Windows NativeのPythonでC拡張をビルドする方法を説明します。みなさん普通は
WindowsではPythonなんて使わないのか、あんまり情報が無いんですよね……</p>
<div class="section" id="windows-sdk">
<h2>Windows SDKをインストールする</h2>
<p>C拡張なのでCコンパイラが必要なので、コンパイラをインストールします。MicrosoftはVistual Studioを売っているのでそれを買えばコンパイラがついてきます。また、無償版のExpress Editionをインストールしてもコンパイラがついてきます。</p>
<p>C拡張をうまいことビルドするために、distutilsはVS2008のコンパイラに対応するように書かれています。UNIXだと適当にPATHからコンパイラを探してくれば良いのに、なぜWindowsだとdistutilsがVS2008のための特別な処理を入れているかというと、コンパイラの場所がWindowsだとPATHに入っていなかったりして、レジストリから推測しなければならないからです。残念OSですね……</p>
<p>レジストリからコンパイラの場所を推測する関係で、より新しいバージョンのVSには対応できていません(レジストリエントリの場所が違うので)。そして、最近対応しているVS2008の(一部のVC++ 2008の)Express Editionのダウンロードができなくなったようです。(<a class="reference external" href="http://mail.python.org/pipermail/python-dev/2013-March/124624.html">[Python-Dev] VC++ 2008 Express Edition now locked away?</a>)コンパイラが入手できないのではdistutilsが対応するまでWindows上ではC拡張をビルドすることができません。</p>
<p>案ずることはありません。まだ道はあります。我々が欲しいのはコンパイラのみです。
MicrosoftはIDEがついてこないコンパイラ単体も配布しています。それがWindows SDKです。ちょっと前までPlatform SDKという名前だった気がします。VS2008のバージョンと互換性があるのは<a class="reference external" href="http://www.microsoft.com/en-us/download/details.aspx?id=3138">Microsoft Windows SDK for Windows 7 and .NET Framework 3.5 SP1</a>という
Windows SDKでこちらはまだダウンロード可能です。こちらをインストールしましょう。</p>
</div>
<div class="section" id="vcvarsall-bat">
<h2>vcvarsall.batをつくる</h2>
<p>この状態でpython setup.py buildをやるとvcvarsall.batがないという趣旨のことを言われてビルドできません。このvcvarsall.batはVS2010と互換性のあるバージョンのWindows SDKだとついてきているのですが、2008と互換性のあるバージョンのSDKだとついてこないようです。中身は単純で現在のシステムが64bitか32bitかによって(これは引数でも指定できるようです)使うコンパイラを選択するという単純なバッチファイルです。コンパイラの選択もほかのバッチファイルを呼んでいるだけですので、自作しましょう。</p>
<p><tt class="docutils literal"><span class="pre">C:\Program</span> Files <span class="pre">(x86)\Microsoft</span> Visual Studio 9.0\VC\vcvarsall.bat</tt>を作成します。32bit版Pythonを利用している場合は、:</p>
<pre class="literal-block">
&#64;call &quot;%~dp0bin\vcvars32.bat&quot;
</pre>
<p>という行を、64bit版の場合は:</p>
<pre class="literal-block">
&#64;call &quot;%~dp0bin\vcvars64.bat&quot;
</pre>
<p>という行を一行書いて保存します。64bit版Windowsではない場合は適宜Program Filesを読み替えてください。</p>
<p>これでC拡張をコンパイルできるようになります。</p>
</div>
<div class="section" id="id1">
<h2>より新しいバージョンを利用する方法</h2>
<p>より新しいバージョンのコンパイラを利用する方法もあります。残念ながらdistutilsは(Python本体がコンパイルされたバージョンである)MSVC2008のコンパイラしか認識してくれないので、その部分をスキップしてPATHから探すようにします。</p>
<p>環境変数に<tt class="docutils literal">MSSdk</tt>と<tt class="docutils literal">DISTUTILS_USE_SDK</tt>という変数を追加して下さい。値はなんでも構いません。これによりdistutilsはパスが通っているところからcl.exeやlink.exeを探します。</p>
<p>この方法の注意点は、Cygwin上でWindowsネイティブのPythonを利用してC拡張のコンパイルをしようとすると、CygwinのGCCのlink.exeが利用されてしまうことと、Python本体と依存するライブラリが変わることです。後者によりpy2exeなどでexeにして配布するときに、実行環境で再頒布可能パッケージがなくて実行できない可能性があります。
(再頒布可能パッケージをインストールすれば実行可能です)</p>
</div>
</div>
        <hr />
    </div>



    <div class='article'>
        <div class="content-title">
            <h1><a href="./2013/03/10/937d07c5-9136-4520-8310-17cdce1bb0eb.html">所得税・住民税についてのメモ</a></h1>
            <div class="metadata">
    <span class="label label-inverse">2013/03/10</span>
    <a href="./category/articles.html" class="label label-info">Articles</a>
</div>        </div>

        <div class="content-body"><p>社会人になるであろうちょっと手前で税金について調べなければいけなくなったので、必要であろうところだけ書く。正確なことはわからないので、詳しくは<a class="reference external" href="http://www.nta.go.jp/taxanswer/shotoku/shotoku.htm">タックスアンサー</a>を見ればいいと思う。というかタックスアンサーを最初から最後まで全部読めばだいたい分かる話。</p>
<p>ちなみに会社に入ると使用者側がそこら辺をやってくれる。なので大体の人はあまり関係ないらしい。確かに自分の両親に聞いてもあまり良くわからない感じだった。</p>
<div class="section" id="id3">
<h2>税金</h2>
<p>ざっくり言うと「(所得 - 所得控除) * 税率 - 控除 - 税額控除 = 所得税額」になっている模様。東京都しか知らないけれど住民税もほぼ同じ構図になっていて、少しずつ額や比率が違う。</p>
<div class="section" id="id4">
<h3>所得</h3>
<p>所得はいろいろ種類があるらしい。その種類によって税金のかかり方が変わったりするみたいだが、アルバイトの場合は給与所得になるはず。なんかの賞金とかだと一時所得になるのだろうか。</p>
</div>
<div class="section" id="id5">
<h3>所得控除</h3>
<p>得た所得に対して「こういうことに使った額については税金かけないよ」とか「あなたがこういう事情の人だったら税金かけないよ」というのが控除。いろいろ種類があるけど、一覧は<a class="reference external" href="http://www.nta.go.jp/taxanswer/shotoku/shoto320.htm">所得金額から差し引かれる金額(所得控除)</a>を見る。</p>
<p>関係有りそうな控除はこんな感じ</p>
<dl class="docutils">
<dt>基礎控除</dt>
<dd>まずみんな一律で38万円は控除される</dd>
<dt>医療費控除</dt>
<dd>病気や怪我をして医療費がかかると控除される</dd>
<dt>給与所得控除</dt>
<dd>給与所得がある場合にその額に応じて控除される</dd>
<dt>社会保険料控除</dt>
<dd>年金払ってると控除される</dd>
<dt>勤労学生控除</dt>
<dd>苦労している学生だと控除される</dd>
<dt>扶養控除</dt>
<dd>誰か養っていると控除される</dd>
</dl>
<p>ただ、なんか色々制限があって、例えば医療費控除は10万超えないと控除されないし、しかも保険がおりるとその分は控除対象から外れる。他にも勤労学生控除とかアルバイトしすぎて180万とかだと稼ぎすぎて逆に勤労学生じゃないということで控除対象外になる。</p>
<p>あと、親から「いい？何があっても103万より多く稼いじゃダメよ」ということを言われている人もいると思うが、これは扶養控除の対象になるのが「給与所得から給与所得控除を引いた額が38万円以下の人」なので、そこから逆算すると103万より多く稼ぐと扶養控除の対象にならずに控除額が減って親の税金が増えるためだ。</p>
</div>
<div class="section" id="id7">
<h3>税率・控除</h3>
<p>所得から所得控除を引いて残った額(課税される所得金額)に対して、XX%の税率をかけると(基本的には)税金の額になる。ここよくわかってないが、日本は超過累進税率という制度らしく、その課税される所得金額があるラインを超えると、その超えた分に対して課税されるという仕組みらしい。</p>
<p>よくわからないので、そこら辺は<a class="reference external" href="http://www.nta.go.jp/taxanswer/shotoku/2260.htm">所得税の税率</a>を見ましょう。この表をみて計算すれば一発でわかる。</p>
<p>先ほどの親の税金は「失われた控除額 * 税率」分だけ増えることと思うので、大学生で親の税率が23%だとすると「63万円 * 23% = 15万円弱」、33%だとすると「63万円 *
33% = 21万円弱」の税金が増えることになるのだと思う。ひぃー！</p>
</div>
<div class="section" id="id9">
<h3>税額控除</h3>
<p>最後になんか税額そのものから引ける控除があるが、あまり関係ないと思う。eTaxで確定申告をやると3000円ぐらい控除される。</p>
</div>
</div>
<div class="section" id="id10">
<h2>税金の納付・還付</h2>
<p>税額を計算した結果の額だけ納めることになるが、実際は給与から源泉徴収という形で毎月引かれてたりする。この源泉徴収はみなしでだいたい最終的にこれぐらい税金払うことになるだろう、という感じで納めるものらしい。なので最終的な額と食い違う場合があるので年末調整とかして税額を確定させる。多く払いすぎていた場合は還付される。</p>
</div>
<div class="section" id="id11">
<h2>住民税</h2>
<p>住民税もだいたいおなじ仕組みで計算されている。ただちょっとずつ額とか割合が違うのでちょっとずつ変えて計算すれば良い。</p>
</div>
<div class="section" id="id12">
<h2>よく言われる103万の壁、130万の壁とは</h2>
<p>基礎控除 + 給与所得控除の最低額 = 103万。それ以外に控除がない場合は、それ以上稼いだら所得税が発生する。どちらかと言うと先にでた親の扶養から外れるのが大きいのだと思う。</p>
<p>基礎控除 + 給与所得控除の最低額 + 勤労学生控除 = 130万。学生の場合は勤労学生控除も適用できるので130万を超えない限りは所得税が発生しない。しかし、130万を超えた瞬間に勤労学生控除が適用できなくなるので一気に所得税が発生する。</p>
<p>ちなみに東京都の場合は、基礎控除 + 給与所得控除の最低額 = 98万、基礎控除 + 給与所得控除の最低額 + 勤労学生控除 = 124万なので、それぞれ同じような感じで住民税が発生する。税率が一律10%なので、所得税よりも高くついたりする。</p>
<p>あと、130万の壁を突破すると131万ジャストで稼いだときよりも、130万ジャストで稼いだときのほうが手取り収入が多いという現象が起こる。</p>
</div>
<div class="section" id="id13">
<h2>つらぽよ……</h2>
<p>調べてたら130万超えると親の医療保険入れないらしいので自分で国民健康保険はいらないといけないらしい。住民税で4,5万払うことになってうわぁ……と思ってたら国民健康保険料が二桁万円いってて僕の口座残高が悲しいことになることが予想される。</p>
</div>
<div class="section" id="id14">
<h2>追記</h2>
<p>どうやら国民健康保険料の計算を間違えてたばかりか、そもそもアルバイト収入の場合扶養に入るかどうかの判定方法が違ったらしく、親の健康保険に入れることになった。なんか儲けた気分。ただ代わりに年金の学生特例が使えないこともわかったけどね……</p>
</div>
</div>
        <hr />
    </div>


     <div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="./index.html">1</a></li>
    <li class=""><a href="./index2.html">2</a></li>
    <li class=""><a href="./index3.html">3</a></li>
    <li class=""><a href="./index4.html">4</a></li>
    <li class=""><a href="./index5.html">5</a></li>
    <li class=""><a href="./index6.html">6</a></li>
    <li class=""><a href="./index7.html">7</a></li>

    <li class="next"><a href="./index2.html">Next &rarr;</a></li>

</ul>
</div> 
</div>

<div id="footer">
    <div id="about">
        <ul class="nav nav-list">
            <li class="nav-header">About the author</li>
        </ul>

        <div style="padding: 10px;">
            <a id="about-image" href="./pages/about.html" rel="alternate"><img src="./static/images/draftcode.png" style="width: 100.0px; height: 100.0px;"/></a>
            <p>東京で情報工学を専攻している大学院生です。</p>
        </div>
    </div>

    <div id="site">
        <ul class="nav nav-list">
            <li class="nav-header">Site</li>

            <li><a href="./archives.html">Archives</a>
            <li><a href="./atom.xml" rel="alternate">Atom feed</a></li>
        </ul>
    </div>

    <div id="category">
        <ul class="nav nav-list">
            <li class="nav-header">Categories</li>
                        <li><a href="./category/android.html">Android</a></li>            <li><a href="./category/articles.html">Articles</a></li>            <li><a href="./category/java.html">Java</a></li>            <li><a href="./category/python.html">Python</a></li>        </ul>
    </div>

    <div id="social">
        <ul class="nav nav-list">
            <li class="nav-header">Social</li>
                        <li class="social"><a href="http://twitter.com/#!/draftcode">Twitter</a></li>            <li class="social"><a href="http://github.com/draftcode">GitHub</a></li>            <li class="social"><a href="https://plus.google.com/107177890582465029754?rel=author">Google+</a></li>        </ul>
    </div>
</div>

</body>
</html>