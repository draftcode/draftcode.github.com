<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>draftcode.github.io</title>
    <meta name="author" content="draftcode">
    <meta name="google-site-verification" content="YjRoDozMq67s3NKiyM6spjwqnSVihlZ11ur-OgfZCU0">

    <link href="./theme/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <link href="./theme/print.css" media="print" rel="stylesheet" type="text/css" />
    <!--[if IE]>
    <link href="./theme/ie.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <![endif]-->

    <link rel="alternate" type="application/atom+xml" title="Atom" href="./atom.xml">
    <link href='http://fonts.googleapis.com/css?family=Economica' rel='stylesheet'>
  </head>

  <body>
    <h1 id="site-title"><a href=".">draftcode.github.io</a></h1>

    <div id="content">
      

<div class='article'>
  <div class="content-title">
    <h1><a href="./2013/06/08/faf853f8-7aea-428c-8e3c-3108b83835b7.html">XPS13を買ってLinuxを入れた話</a></h1>
  </div>
  <dl class="metadata">
    <dt>Posted</dt>
    <dd>2013/06/08</dd>
  </dl>

  <div class="content-body section"><p>最近Macbook Airがスリープから復帰してログインした直後に、すぐに再度スリープに入ってしまうという現象が起きていて、イライラしていた。ということとはあまり関係がなく、どちらかというとそろそろ3年経ったから次のPCを買おうかなということで、
XPS13を買いました。先のようなこともあり、次は脱Appleしようかなということで、適当に日本からキーボードの種類が選べるものを探して買った感じです。Thinkpad X1
Carbonとも迷ったのですが、まぁXPS13のほうが安かったので。</p>
<p>ちょうど1年ぐらいまえにLinuxデスクトップを使い始めていたので、移行自体はすんなり行きました。参考にしたのは次の2つのページです:</p>
<ul class="simple">
<li><a class="reference external" href="http://qiita.com/items/12f21126c5117e07decd">Arch Linux インストールから awesome 導入まで - Qiita</a></li>
<li><a class="reference external" href="https://wiki.archlinux.org/index.php/Installation_Guide">Installation Guice - ArchWiki</a></li>
</ul>
<p>せっかくだからということで、GPTパーティション+EFIという構成でセットアップしたのですが、ドハマりしました。一番ハマったのは、Protective MBRにある部分はBootフラグを立ててはいけないというもので、これをそのままにしておいた結果、いつまでたってもEFIパーティションが認識されないという状況になっていました。</p>
<p>あと、最初に入っていたWindows8を消してWindows7を入れなおそうとしたら、どうやらこのXPS13はEFI起動の64bit Windows7インストールに失敗するようです……残念。</p>
<p>それ以外はファンがすぐに回るとか、タッチパッドの感度が良すぎるとか、TWMを使っているのだけれども、それとibusの候補ウィンドウのフォーカスの関係で、文字入力がしづらいという事以外は、概ね快適であります。</p>
</div>
</div>


<div class='article'>
  <div class="content-title">
    <h1><a href="./2013/03/22/278e1973-0066-4749-8097-3a7dec906e0e.html">PythonのC拡張を書く</a></h1>
  </div>
  <dl class="metadata">
    <dt>Posted</dt>
    <dd>2013/03/22</dd>
  </dl>

  <div class="content-body section"><p>最近はPythonのC拡張を書いていたりするので、覚えている範囲でハマった点を説明します。C拡張を書き始めるには、基本的に<a class="reference external" href="http://docs.python.jp/2/extending/index.html">Python インタプリタの拡張と埋め込み</a>をみて、あとは見よう見まねで書きながら<a class="reference external" href="http://docs.python.jp/2/c-api/index.html">Python/C API リファレンスマニュアル</a>を見とけばOKです。</p>
<div class="section" id="id1">
<h2>やると良いこと・ハマったこと</h2>
<div class="section" id="decref">
<h3>引数はDECREFしてはいけない</h3>
<p>Pythonのドキュメントをよく読んでないのも悪いのですが、どうやらPythonからCで書かれた関数を呼びだされたときに渡ってくる引数はDECREFしてはいけないようです。
Python組み込みのAPI用意している分にはドキュメントにNew Referenceとか書いてあるのでそれをみて判断すればいいです。</p>
</div>
<div class="section" id="decref2">
<h3>DECREFの引数は2回以上評価される可能性のあるマクロなので変数のみ渡す</h3>
<p>同じくDECREF周りですが、Py_DECREFとかはマクロなので引数が複数回評価される可能性があります。というかされます。なので<tt class="docutils literal"><span class="pre">Py_DECREF(PyObject_CallFunction(...))</span></tt>みたいなことをすると死にます。</p>
</div>
<div class="section" id="cpython">
<h3>cpythonのソースコードは手元に持っておく</h3>
<p>正直ドキュメントを参照するよりかはソースコード直接読んだほうが早かったりするので、cpythonのソースコードは手元においておきましょう。というかPythonのスクリプトを書いててもドキュメントに書いてない感じのこととか、曖昧な感じがする点があったりして、そういうときにソースコード手元に持っておくとすぐ確認できて便利です。</p>
</div>
<div class="section" id="id2">
<h3>デバッグ版Pythonを使う</h3>
<p>多分これは自分が高速化のために文字列の可変長配列を自分で持っていたりとか、そういうことをしているからだと思いますが、メモリ周りのエラーで苦しみました。ひたすらSegmentation Faultします。デバッグ版のPythonを使うとメモリまわりでチェックが走るのである程度メモリエラーを検出できます。Pythonは自前でメモリ割り当てを行なっている関係なのか、Valgrindとかを使ってもあんまりInvalid writeみたいなのは検出できなかったです。(Valgrindの仕組みとかよくわかってない)</p>
<p>デバッグ版Pythonのビルドの仕方は<a class="reference external" href="http://docs.python.org/devguide/">Python Developer's Guide</a>に書いてあるのでこれを見て<tt class="docutils literal"><span class="pre">--with-pydebug</span></tt>をつければOKです。自分は<a class="reference external" href="https://github.com/yyuu/pyenv">pyenv</a>を使っているので、そのプラグインの python-build を改造してデバッグ版ビルドができるようにしました。そのうち整理してPull-Request投げてみるかも。</p>
</div>
<div class="section" id="yep">
<h3>yepをつかってプロファイリング</h3>
<p><a class="reference external" href="https://pypi.python.org/pypi/yep">yep</a>はバックエンドで<a class="reference external" href="https://code.google.com/p/gperftools/">gperftools</a>を使ってプロファイリングをしてくれるモジュールです。普通にPython付属のプロファイラだとPythonのコードしかプロファイリングできないので、このモジュールを使ってどこが遅くなっているのかを調べます。</p>
</div>
</div>
<div class="section" id="id4">
<h2>よくわかってないこと</h2>
<div class="section" id="gc">
<h3>GC周り</h3>
<p>どうやらオブジェクト内に外のオブジェクトを含み場合は、普通はGCを有効にしなければいけない感じのようなのですが、別に自分が書いているクラスはユニコード文字列とファイルライクオブジェクトなので、GC周りのフラグを立てていません。GC-awareな書き方は、多分ドキュメント見ればわかるんだろうと思いつつ、よくわかってません。</p>
</div>
</div>
</div>
</div>


<div class='article'>
  <div class="content-title">
    <h1><a href="./2013/03/17/5f45fabb-8b64-469e-a0f6-7f9d76564af8.html">Windows環境でPythonのC拡張をビルドする</a></h1>
  </div>
  <dl class="metadata">
    <dt>Posted</dt>
    <dd>2013/03/17</dd>
  </dl>

  <div class="content-body section"><p>Windows NativeのPythonでC拡張をビルドする方法を説明します。みなさん普通は
WindowsではPythonなんて使わないのか、あんまり情報が無いんですよね……</p>
<div class="section" id="windows-sdk">
<h2>Windows SDKをインストールする</h2>
<p>C拡張なのでCコンパイラが必要なので、コンパイラをインストールします。MicrosoftはVistual Studioを売っているのでそれを買えばコンパイラがついてきます。また、無償版のExpress Editionをインストールしてもコンパイラがついてきます。</p>
<p>C拡張をうまいことビルドするために、distutilsはVS2008のコンパイラに対応するように書かれています。UNIXだと適当にPATHからコンパイラを探してくれば良いのに、なぜWindowsだとdistutilsがVS2008のための特別な処理を入れているかというと、コンパイラの場所がWindowsだとPATHに入っていなかったりして、レジストリから推測しなければならないからです。残念OSですね……</p>
<p>レジストリからコンパイラの場所を推測する関係で、より新しいバージョンのVSには対応できていません(レジストリエントリの場所が違うので)。そして、最近対応しているVS2008の(一部のVC++ 2008の)Express Editionのダウンロードができなくなったようです。(<a class="reference external" href="http://mail.python.org/pipermail/python-dev/2013-March/124624.html">[Python-Dev] VC++ 2008 Express Edition now locked away?</a>)コンパイラが入手できないのではdistutilsが対応するまでWindows上ではC拡張をビルドすることができません。</p>
<p>案ずることはありません。まだ道はあります。我々が欲しいのはコンパイラのみです。
MicrosoftはIDEがついてこないコンパイラ単体も配布しています。それがWindows SDKです。ちょっと前までPlatform SDKという名前だった気がします。VS2008のバージョンと互換性があるのは<a class="reference external" href="http://www.microsoft.com/en-us/download/details.aspx?id=3138">Microsoft Windows SDK for Windows 7 and .NET Framework 3.5 SP1</a>という
Windows SDKでこちらはまだダウンロード可能です。こちらをインストールしましょう。</p>
</div>
<div class="section" id="vcvarsall-bat">
<h2>vcvarsall.batをつくる</h2>
<p>この状態でpython setup.py buildをやるとvcvarsall.batがないという趣旨のことを言われてビルドできません。このvcvarsall.batはVS2010と互換性のあるバージョンのWindows SDKだとついてきているのですが、2008と互換性のあるバージョンのSDKだとついてこないようです。中身は単純で現在のシステムが64bitか32bitかによって(これは引数でも指定できるようです)使うコンパイラを選択するという単純なバッチファイルです。コンパイラの選択もほかのバッチファイルを呼んでいるだけですので、自作しましょう。</p>
<p><tt class="docutils literal"><span class="pre">C:\Program</span> Files <span class="pre">(x86)\Microsoft</span> Visual Studio 9.0\VC\vcvarsall.bat</tt>を作成します。32bit版Pythonを利用している場合は、:</p>
<pre class="literal-block">
&#64;call &quot;%~dp0bin\vcvars32.bat&quot;
</pre>
<p>という行を、64bit版の場合は:</p>
<pre class="literal-block">
&#64;call &quot;%~dp0bin\vcvars64.bat&quot;
</pre>
<p>という行を一行書いて保存します。64bit版Windowsではない場合は適宜Program Filesを読み替えてください。</p>
<p>これでC拡張をコンパイルできるようになります。</p>
</div>
<div class="section" id="id1">
<h2>より新しいバージョンを利用する方法</h2>
<p>より新しいバージョンのコンパイラを利用する方法もあります。残念ながらdistutilsは(Python本体がコンパイルされたバージョンである)MSVC2008のコンパイラしか認識してくれないので、その部分をスキップしてPATHから探すようにします。</p>
<p>環境変数に<tt class="docutils literal">MSSdk</tt>と<tt class="docutils literal">DISTUTILS_USE_SDK</tt>という変数を追加して下さい。値はなんでも構いません。これによりdistutilsはパスが通っているところからcl.exeやlink.exeを探します。</p>
<p>この方法の注意点は、Cygwin上でWindowsネイティブのPythonを利用してC拡張のコンパイルをしようとすると、CygwinのGCCのlink.exeが利用されてしまうことと、Python本体と依存するライブラリが変わることです。後者によりpy2exeなどでexeにして配布するときに、実行環境で再頒布可能パッケージがなくて実行できない可能性があります。
(再頒布可能パッケージをインストールすれば実行可能です)</p>
</div>
</div>
</div>

 
<div class="pagination">
  <ul>
        <li class="prev disabled">&larr; Previous</li>
    
            <li class="active">1</li>
                <a href="./index2.html"><li>2</li></a>
                <a href="./index3.html"><li>3</li></a>
                <a href="./index4.html"><li>4</li></a>
                <a href="./index5.html"><li>5</li></a>
                <a href="./index6.html"><li>6</li></a>
                <a href="./index7.html"><li>7</li></a>
        
        <a href="./index2.html"><li class="next">Next &rarr;</li></a>
      </ul>
</div>

 
    </div>

    <div id="footer">
      <div id="footer-container">
        <div id="about">
          <h2>About the author</h2>
          <a href="./pages/about.html"><img src="./static/images/draftcode.png" /></a>
          <p>東京で情報工学を専攻している大学院生です。<br />プログラミング言語の研究をしています。<br /></p>
          <p>詳しくは<a href="./pages/about.html">こちら</a></p>
        </div>

        <div id="site">
          <h2>Site</h2>
          <ul>
            <li><a href="./archives.html">Archives</a>
            <li><a href="./atom.xml" rel="alternate">Atom feed</a></li>
          </ul>
        </div>

        <div id="social">
          <h2>Social</h2>
          <ul>
                        <li class="social"><a href="http://twitter.com/#!/draftcode">Twitter</a></li>            <li class="social"><a href="http://github.com/draftcode">GitHub</a></li>            <li class="social"><a href="https://plus.google.com/107177890582465029754?rel=author">Google+</a></li>          </ul>
        </div>
      </div>
    </div>
  </body>
</html>