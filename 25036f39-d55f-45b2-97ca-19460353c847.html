<!DOCTYPE html>
<html lang="en">
<head>
        <title>RoboGuiceのInjectExtraを使うとテストがしにくくなる件について</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
                <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="A Pelican Blog Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">A Pelican Blog </a></h1>
                <nav><ul>
                                                                    <li><a href="./pages/about.html">About</a></li>
                                                                    <li class="active"><a href="./category/android.html">Android</a></li>
                                    <li ><a href="./category/java.html">Java</a></li>
                                    <li ><a href="./category/python.html">Python</a></li>
                                    <li ><a href="./category/articles.html">articles</a></li>
                                    <li ><a href="./category/misc.html">misc</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./25036f39-d55f-45b2-97ca-19460353c847.html" rel="bookmark"
           title="Permalink to RoboGuiceのInjectExtraを使うとテストがしにくくなる件について">RoboGuiceのInjectExtraを使うとテストがしにくくなる件について</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2012-09-23T23:58:12">
                Sun 23 September 2012
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/draftcode.html">draftcode</a>
        </address>
        <p>In <a href="./category/android.html">Android</a>. </p>

</footer><!-- /.post-info -->      <p>RoboGuiceのInjectなんとか系は記述量が減ってテストもしやすくなって便利ですが、
残念ながらInjectExtraだけはイマイチと言わざるを得ません。使っているバーション
は、RoboGuice 1.1.2とGuice 2.0 no-aopで、Robolectricでテストを書いたりしていま
す。もしかしたら、RoboGuice 2.0で解消されているのかも知れません。</p>
<div class="section" id="id1">
<h2>問題背景</h2>
<p>まず、実機で動くコードでは、 <tt class="docutils literal">RoboActivity.onCreate()</tt> の中でInjectionが行わ
れます。このとき、 <tt class="docutils literal">InjectView</tt> 以外のフィールドがInjectされます。その中には
当然 <tt class="docutils literal">InjectExtra</tt> も入っていますので、ここでそのInjectionのContextである
ActivityからIntentがとり出されて、Extraが入ります:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SOME_EXTRA_ID</span> <span class="o">=</span> <span class="s">&quot;SOME_EXTRA_ID&quot;</span><span class="o">;</span>
<span class="nd">@InjectExtra</span><span class="o">(</span><span class="n">SOME_EXTRA_ID</span><span class="o">)</span>
<span class="kt">int</span> <span class="n">someExtra</span><span class="o">;</span>
</pre></div>
<p>次に、テストコードの中で、クラス中にテスト対象のActivityをInjectしているとしま
す。このとき、Activityに <tt class="docutils literal">InjectExtra</tt> が入っているとInjectionに失敗してしま
います。失敗する理由としては、次の2つが挙げられます。</p>
<ol class="arabic simple">
<li>Injectionを行うActivityにIntentがセットされていないこと。</li>
<li>Injectionを行うScopeが <tt class="docutils literal">ContextScope</tt> ではないこと。特に、Activityの
<tt class="docutils literal">ContextScope</tt> ではないこと。</li>
</ol>
</div>
<div class="section" id="id2">
<h2>解決策</h2>
<p>この2つを回避するために、それなりに現実的な方法で対処をしてみようと試みました
が、根本的に実際に実機で動くときのコードとテスト中のコードでInjectionタイミン
グが違うことが問題なので、上手く行きませんでした。Activityはどこかほかのオブ
ジェクトの中でInjectされることを、あまり想定していないのです。</p>
<p>大掛かりな解決策としては、 <tt class="docutils literal">ExtrasListener</tt> と <tt class="docutils literal">ContextScope</tt> を変更して、
<tt class="docutils literal">InjectExtra</tt> が処理されるタイミングを変更するというものがありますが、そこま
でして <tt class="docutils literal">InjectExtra</tt> を使いたくありません。</p>
<p>大掛かりな解決策を取らずに <tt class="docutils literal">InjectExtra</tt> を利用したActivityに対してテストを
書くのであれば、ActivityはテストコードでのInjecされないようにして、 <tt class="docutils literal">setUp</tt>
の中で手動Injectするしかありません。その手動Injectを行う場合には、自分でその
Activityの <tt class="docutils literal">ContextScope</tt> を生成して、その中で <tt class="docutils literal">injectMembers</tt> を行う必要
があります。この方法を取ると、一見、テストコード中の <tt class="docutils literal">InjectView</tt> が効かなく
なりそうですが、どうやら <tt class="docutils literal">ContextScope</tt> のスタックがきちんとしているのか、そ
のActivityが <tt class="docutils literal">setContentView</tt> をしたときに、きちんとInjectionされます:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TEST_EXTRA</span> <span class="o">=</span> <span class="mi">42</span><span class="o">;</span>

<span class="nd">@Inject</span>
<span class="n">Injector</span> <span class="n">injector</span><span class="o">;</span>
<span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">myButton</span><span class="o">)</span>
<span class="n">Button</span> <span class="n">myButton</span><span class="o">;</span>

<span class="kd">private</span> <span class="n">MyActivity</span> <span class="n">activity</span><span class="o">;</span>

<span class="nd">@Before</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">activity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyActivity</span><span class="o">();</span>
    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">MyActivity</span><span class="o">.</span><span class="na">SOME_EXTRA_ID</span><span class="o">,</span> <span class="n">TEST_EXTRA</span><span class="o">);</span>
    <span class="n">activity</span><span class="o">.</span><span class="na">setIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>

    <span class="n">ContextScope</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ContextScope</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">scope</span><span class="o">.</span><span class="na">enter</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
    <span class="n">injector</span><span class="o">.</span><span class="na">injectMembers</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
    <span class="n">scope</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p><tt class="docutils literal">ContextScope</tt> 周りは、RoboGuice 2.0では多少改善されているのは確認できまし
た。 <tt class="docutils literal">RoboGuice.injectMembers(Context, T)</tt> というメソッドが存在するのが確認
できました。</p>
<p>もうひとつの解決策は、もう <tt class="docutils literal">InjectExtra</tt> を使わないという方法で、自分はもう
こっちの方法でいいかなと思っています。</p>
</div>

    </div><!-- /.entry-content -->
    
  </article>
</section>
        <section id="extras" class="body">
                        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>