===============================================
HomebrewでクロスコンパイルできるGCCをビルドする
===============================================
:Author: draftcode
:Date:   2012-02-06
:Slug:   235454

Mac OS X 10.7.2 の Intel Core i7 を乗っけているMacbook Airで、Homebrewをつかっ
てクロスコンパイラをビルドします。

結論
====

https://gist.github.com/1751385 のようなFormulaをつくればできます。このFormula
は http://pdos.csail.mit.edu/6.828/2011/xv6.html をビルドするために、
http://pdos.csail.mit.edu/6.828/2011/tools.html の設定を参考にして書きました。

クロスコンパイラ……ぐぬぬ……
==============================

クロスコンパイラは、以前自分が某研究室で作っているMIPSライクなCPUを使ったマシ
ンで動くアセンブラを書いたときにもビルドしたのですが、なぜか動かなかったりしま
す。なんか検索してみると、動かない動かないと言っている人も結構いたりするので失
敗しやすいのでしょう。今回は無事動くところまでこぎ着けました。

Homebrewでビルドするときの問題点
================================

Homebrewは既にパッケージとして用意してくれているものについてはビルドしない方針
なので、GCCをビルドしたりするFormulaはありません。なので適当にでっち上げる必要
があります。いろいろな人が既にGCCのFormulaを書いているので、それを参考に書けば
良いのですが、適当にクロスコンパイラのFormulaを書くと失敗します。

GCCはコンパイルをした後に、binutilsを使ってバイナリをはき出します。なので、ク
ロスコンパイルができるGCCをビルドするには、そのターゲットとなるプラットフォー
ム用のbinutilsが必要です。そのbinutilsのツールを探すのに、GCCはいろいろな場所
をみてくれます。どこを探すかは
http://gcc.gnu.org/install/configure.html#with-as に書いてあって、どうも
i386-foo-bar-asというのをPATHをみて探してくれるようです。適当にbinutilsとGCC
で同じTargetを指定すれば良さそうなかんじ。

が、駄目。動きません。GCCのビルドは成功するのですが、そのGCCでなんかコンパイル
しようとすると、どうもアセンブラがエラーを吐いているようです。実行されているコ
マンドを見てみると、システム組み込みのasを使っているようです。そりゃ駄目だ。

こんなの絶対おかしいよ。ということで、GCCのソースを見てみることに。いろいろか
けずり回った結果、 ``gcc/gcc.c`` の ``find_a_file()`` あたりでファイルを探して
いるようなのですが、なんかi386-foo-barみたいなマシンターゲットをつけているよう
には見えないぞ。あやしい。ちなみにldのほうは ``gcc/collect2.c`` の ``main`` で
そういうプレフィックスをつけていて、ファイルを探すのもasとは別のコードで行って
いる模様。

どうも、ldについてはインストールマニュアルに書かれている通りに探してくれている
みたいですが、asについてはなんか違うようです。

解決
====

GCCが正しいアセンブラを探してくれない。仕方がないので手動でアセンブラを指定す
ることになります。ということで、
https://gist.github.com/1751385#file_gcc_xv6.rb のように汚い感じですが、アセン
ブラのパスを手動で指定してあげるようにします。このようにすると、うまくコンパイ
ルができました。(ということは、ldについてはきちんと探してくれたようです……)

もし、Xv6をコンパイルして動かしたい。しかも、Homebrewで必要なものをいれたい。
ということであれば、次のようにすることでうまくインストールすることができます。
QEMUはuse-gccを使わないとうまく動きませんでした:

.. code-block:: text

   brew install https://raw.github.com/gist/1751385/binutils_xv6.rb
   brew install https://raw.github.com/gist/1751385/gcc_xv6.rb
   brew install https://raw.github.com/gist/1751385/gdb_xv6.rb
   brew install qemu --use-gcc

