<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>draftcode.github.io</title>
    <meta name="author" content="draftcode">
    <meta name="google-site-verification" content="YjRoDozMq67s3NKiyM6spjwqnSVihlZ11ur-OgfZCU0">

    <!--[if lt IE 9]>
    <script src="../theme/html5.js"></script>
    <![endif]-->

    <link href="../theme/bootstrap.min.css" rel="stylesheet">
    <link href="../theme/local.css" rel="stylesheet">
    <link href="../theme/pygments.css" rel="stylesheet">
    <link rel="alternate" type="application/atom+xml" title="Atom" href="../atom.xml">
    <link href='http://fonts.googleapis.com/css?family=Economica' rel='stylesheet'>
</head>

<body>

<h1 id="site-title"><a href="..">draftcode.github.io</a></h1>

<div id="content">


    <div class='article'>
        <div class="content-title">
            <h1><a href="../2011/03/14/42aa3a98-4e10-11e0-bcea-d8a25efffee9.html">Macを大きいディスプレイにつなげるときはMini DisplayPort &lt;-&gt; DisplayPort変換ケーブルを使う</a></h1>
            <div class="metadata">
    <span class="label label-inverse">2011/03/14</span>
    <a href="../category/articles.html" class="label label-info">Articles</a>
</div>        </div>

        <div class="content-body"><p>Macbook Proを修理に出したときに，どうしてもレポートを書かなければいけない感じだったので，Mac miniを購入しました．Macbook Proは3年ぐらい前のモデルだったので，大きいDVIポートがあり，DELLのU2711のような大きいディスプレイでも直接接続して最適な解像度が出せたのですが，今のMacについているようなMini DisplayPortだと，DVIとの変換ケーブルを使っても，フルHD程度までしか出力することができません．これはDVIのシングルリンクとかデュアルリンクとかの問題らしいんですが，それを解決するためにはAppleの高いデュアルリンク対応の変換アダプタを購入しなければいけません．</p>
<p>もっとシンプルな解決方法を目指します．最近のディスプレイはDisplayPortがついているようなので，それに変換すれば良いのです．実際自分はMini DisplayPortとDisplayPortの変換ケーブルを使って，大きい解像度の出力ができるようになっています．</p>
<p>残念ながら，このような変換ケーブルはあまり製造されていないようです．自分は<a class="reference external" href="http://store.shopping.yahoo.co.jp/ats/0203.html">ATS Direct</a>というサイトで購入しました．</p>
<p>またDisplayPortは音声出力も対応しているので，U2711の音声出力から音を出すこともできています．しかしながらU2711側では音量調節ができないので，音量調節ができるようなもの(スピーカーなど)でないと，音が大きすぎて耳がつぶれます．ヘッドホンとかは難しいです．ちなみに出力切り替えはSoundflowerを使うと便利です．</p>
<div class="section" id="id1">
<h2>追記 (2011-06-22)</h2>
<p>どうも探し方が悪かったようで，他にもいくつか見つかりました．</p>
<ul class="simple">
<li><a class="reference external" href="http://www.amazon.co.jp/dp/B004KB5HM6/">http://www.amazon.co.jp/dp/B004KB5HM6/</a></li>
<li><a class="reference external" href="http://www.amazon.co.jp/dp/B004GCHNP8/">http://www.amazon.co.jp/dp/B004GCHNP8/</a></li>
<li><a class="reference external" href="http://direct.eizo.co.jp/shop/g/gPM200-BK/">http://direct.eizo.co.jp/shop/g/gPM200-BK/</a></li>
</ul>
<p>ただ，ものによっては映らないものもあるみたいですね．</p>
</div>
<div class="section" id="id2">
<h2>追記 (2012-03-11)</h2>
<p>音声出力の切り替えはOptionキーを押しながらメニューバーの音量調節アイコンをクリックすると、出力装置の切り替えができるので、これが便利です。最近はU2711に別のスピーカーをつけて、そのスピーカーについている音声出力端子にヘッドホンをつけたりしています。</p>
</div>
</div>
        <hr />
    </div>



    <div class='article'>
        <div class="content-title">
            <h1><a href="../2012/08/01/5524f2e3-1431-4ee0-b04c-ab89ebdcdf4a.html">第(1+1)回 六本木 Linux カーネル読書会 参加メモ</a></h1>
            <div class="metadata">
    <span class="label label-inverse">2012/08/01</span>
    <a href="../category/articles.html" class="label label-info">Articles</a>
</div>        </div>

        <div class="content-body"><p><a class="reference external" href="http://connpass.com/event/824/">第(1+1)回 六本木 Linux カーネル読書会</a>に行ってきたので、そのときのメモ。あまりメモがとれていない。今回はforkとかcloneあたり。</p>
<p>後で調べたこともいくつか追加している。</p>
<div class="topic">
<p class="topic-title first">do_fork (kernel/fork.c)</p>
<p>do_forkはsys_cloneやsys_vfork、sys_forkから呼ばれる。</p>
<dl class="docutils">
<dt>sys_clone</dt>
<dd>arch/x86/kernel/process.c</dd>
<dt>sys_vfork</dt>
<dd>arch/x86/kernel/process.c</dd>
<dt>sys_fork</dt>
<dd>arch/x86/kernel/process.c</dd>
<dt>task_struct</dt>
<dd>include/linux/sched.h</dd>
</dl>
</div>
<div class="topic">
<p class="topic-title first">vfork</p>
<p>古いBSDでfork &amp; execを効率的に行うための仕組み。現在では使われていない。</p>
<p>古いBSDだと、メモリ空間がCopy on Writeではなくて、fork時にコピーするようになっているらしい。このため、fork &amp; execをやろうとすると、無駄にメモリ空間のコピーが走ってしまう。これを防ぐために、vforkというものが生まれた。vforkは子プロセスが親プロセスのメモリ空間を使って動く。このままだと、親プロセスと子プロセスのスタックも共有してしまうので、まず、親プロセスを停止し、次に子プロセスを動かす。子プロセスがexecveを呼ぶかexitするまで、親プロセスは停止する。親プロセスのメモリ空間を利用するため、子プロセスの動きが大きく制約される。</p>
<p><a class="reference external" href="http://surf.ml.seikei.ac.jp/~nakano/JMwww/html/LDP_man-pages/man2/vfork.2.html">http://surf.ml.seikei.ac.jp/~nakano/JMwww/html/LDP_man-pages/man2/vfork.2.html</a></p>
<p>現代的なプログラムではvforkは使ってはいけない。</p>
<p><a class="reference external" href="http://www.jpcert.or.jp/sc-rules/c-pos33-c.html">http://www.jpcert.or.jp/sc-rules/c-pos33-c.html</a></p>
</div>
<div class="topic">
<p class="topic-title first">メモリ空間</p>
<p>カーネル空間とユーザー空間に分かれている。</p>
<dl class="docutils">
<dt>__user</dt>
<dd>include/linux/compiler.h</dd>
<dt>__kernel</dt>
<dd>include/linux/compiler.h</dd>
</dl>
<p>それぞれでメモリ管理をしているので仮想メモリ空間を指すことになる。</p>
</div>
<div class="topic">
<p class="topic-title first">copy_process (kernel/fork.c)</p>
<p>親プロセスのtask_structをコピーしている。</p>
<ul class="simple">
<li>dup_task_structを呼んでる。</li>
<li>sched_forkを呼んでる。</li>
</ul>
</div>
<div class="topic">
<p class="topic-title first">sched_fork (kernel/sched/core.c)</p>
<p>プロセスが実行される前のスケジューラ周りのセットアップを行うみたい。</p>
</div>
<div class="topic">
<p class="topic-title first">dup_task_struct (kernel/fork.c)</p>
<p>task_structのメモリ確保はkmem_cache_alloc_nodeで確保している。</p>
</div>
<div class="topic">
<p class="topic-title first">kmem_cache_alloc_node (include/kernel/slab.h)</p>
<p>カーネル空間のメモリを確保する関数。メモリの種類がいろいろ選べるらしい。</p>
<p><a class="reference external" href="http://www.mech.tohoku-gakuin.ac.jp/rde/contents/linux/drivers/tips1.html">http://www.mech.tohoku-gakuin.ac.jp/rde/contents/linux/drivers/tips1.html</a></p>
<p>kmem_cache_alloc_node の node は tsk_fork_get_node から取ってきている。しかしnodeは無視されてしまう。</p>
</div>
<div class="topic">
<p class="topic-title first">tsk_fork_get_node (kernel/kthread.c)</p>
<p>どうもNUMAアーキテクチャで気にするものらしい。</p>
<p>NUMA は Non-Uniform Memory Access の略で、たしかそれぞれのプロセッサでメモリを持っていて、他のプロセッサが持っているメモリにアクセスするときは、そのプロセッサにお願いして読みに行くというアーキテクチャだったと思う。</p>
</div>
<div class="topic">
<p class="topic-title first">RCUとは</p>
<p>リードコピーアップデート。Wikipedia参照。</p>
<p>どうも、Writerが入るときに、コピーを作ってそっちの方を指すようにする。で、
Readerは読み終わったら上手いことやって、さっきまで見ていた複製元が既に不要になっていたら破棄するようにするものらしい。</p>
<p><a class="reference external" href="http://togetter.com/li/153033">http://togetter.com/li/153033</a></p>
</div>
<div class="topic">
<p class="topic-title first">get_cpu, put_cpu (include/linux/smp.h)</p>
<dl class="docutils">
<dt>get_cpu</dt>
<dd>CPUの割り込みを禁止し、現在のCPUIDを返す。</dd>
<dt>put_cpu</dt>
<dd>CPUの割り込みを有効化。</dd>
</dl>
</div>
<div class="topic">
<p class="topic-title first">wake_up_new_task (kernel/sched/core.c)</p>
<p>do_forkの中で呼び出される。スケジューラに実際に登録する？</p>
</div>
<div class="topic">
<p class="topic-title first">do_execve (fs/exec.c)</p>
<p>これは次回で。</p>
</div>
<div class="topic">
<p class="topic-title first">Buddy memory allocation と Slab allocator</p>
<p>kmem_cache_alloc_node が定義されているのはslab.hなので、slabとは何か調べた。</p>
<p>Buddy memory allocationというメモリアロケーションメカニズムがあって、詳しくはわからないけれど、ページ*2^n単位でメモリを確保していくようなものらしい。これで切り取れるのはページ数単位なので、小さいオブジェクトを確保するのには向いていない。なので間にSlab allocatorというものが入って、小さいオブジェクトを切り出していきましょうという仕組みらしい。mallocと変わらない？いくつかの最適化もされるらしい。</p>
<ul class="simple">
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Buddy_memory_system">http://en.wikipedia.org/wiki/Buddy_memory_system</a></li>
<li><a class="reference external" href="http://wiki.bit-hive.com/linuxkernelmemo/pg/%A5%B9%A5%E9%A5%D6%A5%A2%A5%ED%A5%B1%A1%BC%A5%BF">http://wiki.bit-hive.com/linuxkernelmemo/pg/%A5%B9%A5%E9%A5%D6%A5%A2%A5%ED%A5%B1%A1%BC%A5%BF</a></li>
</ul>
<p>そもそもスラブというものが何かというと、同じサイズのオブジェクトを切り出すためのメモリのことらしい。</p>
<p><a class="reference external" href="http://wiki.bit-hive.com/north/pg/kmalloc(%A5%B9%A5%E9%A5%D6%A5%A2%A5%ED%A5%B1%A1%BC%A5%BF">http://wiki.bit-hive.com/north/pg/kmalloc(%A5%B9%A5%E9%A5%D6%A5%A2%A5%ED%A5%B1%A1%BC%A5%BF</a>)</p>
<p>スラブの割り当て状況みたいなのは/proc/slabinfoで参照できるらしく、さらに
topみたいなslabtopというコマンドもある。</p>
</div>
</div>
        <hr />
    </div>



    <div class='article'>
        <div class="content-title">
            <h1><a href="../2013/03/17/5f45fabb-8b64-469e-a0f6-7f9d76564af8.html">Windows環境でPythonのC拡張をビルドする</a></h1>
            <div class="metadata">
    <span class="label label-inverse">2013/03/17</span>
    <a href="../category/python.html" class="label label-info">Python</a>
</div>        </div>

        <div class="content-body"><p>Windows NativeのPythonでC拡張をビルドする方法を説明します。みなさん普通は
WindowsではPythonなんて使わないのか、あんまり情報が無いんですよね……</p>
<div class="section" id="windows-sdk">
<h2>Windows SDKをインストールする</h2>
<p>C拡張なのでCコンパイラが必要なので、コンパイラをインストールします。MicrosoftはVistual Studioを売っているのでそれを買えばコンパイラがついてきます。また、無償版のExpress Editionをインストールしてもコンパイラがついてきます。</p>
<p>C拡張をうまいことビルドするために、distutilsはVS2008のコンパイラに対応するように書かれています。UNIXだと適当にPATHからコンパイラを探してくれば良いのに、なぜWindowsだとdistutilsがVS2008のための特別な処理を入れているかというと、コンパイラの場所がWindowsだとPATHに入っていなかったりして、レジストリから推測しなければならないからです。残念OSですね……</p>
<p>レジストリからコンパイラの場所を推測する関係で、より新しいバージョンのVSには対応できていません(レジストリエントリの場所が違うので)。そして、最近対応しているVS2008の(一部のVC++ 2008の)Express Editionのダウンロードができなくなったようです。(<a class="reference external" href="http://mail.python.org/pipermail/python-dev/2013-March/124624.html">[Python-Dev] VC++ 2008 Express Edition now locked away?</a>)コンパイラが入手できないのではdistutilsが対応するまでWindows上ではC拡張をビルドすることができません。</p>
<p>案ずることはありません。まだ道はあります。我々が欲しいのはコンパイラのみです。
MicrosoftはIDEがついてこないコンパイラ単体も配布しています。それがWindows SDKです。ちょっと前までPlatform SDKという名前だった気がします。VS2008のバージョンと互換性があるのは<a class="reference external" href="http://www.microsoft.com/en-us/download/details.aspx?id=3138">Microsoft Windows SDK for Windows 7 and .NET Framework 3.5 SP1</a>という
Windows SDKでこちらはまだダウンロード可能です。こちらをインストールしましょう。</p>
</div>
<div class="section" id="vcvarsall-bat">
<h2>vcvarsall.batをつくる</h2>
<p>この状態でpython setup.py buildをやるとvcvarsall.batがないという趣旨のことを言われてビルドできません。このvcvarsall.batはVS2010と互換性のあるバージョンのWindows SDKだとついてきているのですが、2008と互換性のあるバージョンのSDKだとついてこないようです。中身は単純で現在のシステムが64bitか32bitかによって(これは引数でも指定できるようです)使うコンパイラを選択するという単純なバッチファイルです。コンパイラの選択もほかのバッチファイルを呼んでいるだけですので、自作しましょう。</p>
<p><tt class="docutils literal"><span class="pre">C:\Program</span> Files <span class="pre">(x86)\Microsoft</span> Visual Studio 9.0\VC\vcvarsall.bat</tt>を作成します。32bit版Pythonを利用している場合は、:</p>
<pre class="literal-block">
&#64;call &quot;%~dp0bin\vcvars32.bat&quot;
</pre>
<p>という行を、64bit版の場合は:</p>
<pre class="literal-block">
&#64;call &quot;%~dp0bin\vcvars64.bat&quot;
</pre>
<p>という行を一行書いて保存します。64bit版Windowsではない場合は適宜Program Filesを読み替えてください。</p>
<p>これでC拡張をコンパイルできるようになります。</p>
</div>
<div class="section" id="id1">
<h2>より新しいバージョンを利用する方法</h2>
<p>より新しいバージョンのコンパイラを利用する方法もあります。残念ながらdistutilsは(Python本体がコンパイルされたバージョンである)MSVC2008のコンパイラしか認識してくれないので、その部分をスキップしてPATHから探すようにします。</p>
<p>環境変数に<tt class="docutils literal">MSSdk</tt>と<tt class="docutils literal">DISTUTILS_USE_SDK</tt>という変数を追加して下さい。値はなんでも構いません。これによりdistutilsはパスが通っているところからcl.exeやlink.exeを探します。</p>
<p>この方法の注意点は、Cygwin上でWindowsネイティブのPythonを利用してC拡張のコンパイルをしようとすると、CygwinのGCCのlink.exeが利用されてしまうことと、Python本体と依存するライブラリが変わることです。後者によりpy2exeなどでexeにして配布するときに、実行環境で再頒布可能パッケージがなくて実行できない可能性があります。
(再頒布可能パッケージをインストールすれば実行可能です)</p>
</div>
</div>
        <hr />
    </div>


     <div class="pagination">
<ul>
    <li class="prev"><a href="../author/draftcode4.html">&larr; Previous</a></li>

    <li class=""><a href="../author/draftcode.html">1</a></li>
    <li class=""><a href="../author/draftcode2.html">2</a></li>
    <li class=""><a href="../author/draftcode3.html">3</a></li>
    <li class=""><a href="../author/draftcode4.html">4</a></li>
    <li class="active"><a href="../author/draftcode5.html">5</a></li>
    <li class=""><a href="../author/draftcode6.html">6</a></li>
    <li class=""><a href="../author/draftcode7.html">7</a></li>

    <li class="next"><a href="../author/draftcode6.html">Next &rarr;</a></li>

</ul>
</div> 
</div>

<div id="footer">
    <div id="about">
        <ul class="nav nav-list">
            <li class="nav-header">About the author</li>
        </ul>

        <div style="padding: 10px;">
            <a id="about-image" href="../pages/about.html" rel="alternate"><img src="../static/images/draftcode.png" style="width: 100.0px; height: 100.0px;"/></a>
            <p>東京で情報工学を専攻している大学院生です。</p>
        </div>
    </div>

    <div id="site">
        <ul class="nav nav-list">
            <li class="nav-header">Site</li>

            <li><a href="../archives.html">Archives</a>
            <li><a href="../atom.xml" rel="alternate">Atom feed</a></li>
        </ul>
    </div>

    <div id="category">
        <ul class="nav nav-list">
            <li class="nav-header">Categories</li>
                        <li><a href="../category/android.html">Android</a></li>            <li><a href="../category/articles.html">Articles</a></li>            <li><a href="../category/java.html">Java</a></li>            <li><a href="../category/python.html">Python</a></li>        </ul>
    </div>

    <div id="social">
        <ul class="nav nav-list">
            <li class="nav-header">Social</li>
                        <li class="social"><a href="http://twitter.com/#!/draftcode">Twitter</a></li>            <li class="social"><a href="http://github.com/draftcode">GitHub</a></li>            <li class="social"><a href="https://plus.google.com/107177890582465029754?rel=author">Google+</a></li>        </ul>
    </div>
</div>

</body>
</html>