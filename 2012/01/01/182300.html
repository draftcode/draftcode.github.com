<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>Generic型の配列を作るとgeneric array creationやunchecked conversionが出る</title>
    <meta content='draftcode' name='author'>
    <meta content='3T_u3CXt1yC2LeNvWOzsMSPQrs_0Ek-XUnA8DYgu7zY' name='google-site-verification'>
    <link href='/css/main.css' rel='stylesheet'>
    <link href='/atom.xml' rel='alternate' title='Atom' type='application/atom+xml'>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Economica' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <div id='site-title-short'>
      <div class='svg' id='links'>
        <a href='/pages/about.html' id='about'>About</a>
        <a class='fc-webicon twitter' href='http://twitter.com/draftcode'>Twitter</a>
        <a class='fc-webicon github' href='http://github.com/draftcode'>GitHub</a>
        <a class='fc-webicon googleplus' href='https://plus.google.com/107177890582465029754?rel=author'>Google+</a>
        <a class='fc-webicon rss' href='/atom.xml' rel='alternate'>Atom feed</a>
      </div>
      <h1>
        <a href='/'>draftcode.github.io</a>
      </h1>
    </div>
    <div id='content'>
      <div id='article'>
  <div id='content_title'>
    <h1>Generic型の配列を作るとgeneric array creationやunchecked conversionが出る</h1>
  </div>
  <div id='posted_date'>
    Posted on 2012-01-01
  </div>
  <div id='content_body'>
    <h2>結論</h2>
<p>配列はアレなので使ってはいけない</p>
<h2>JavaのGenericsとは</h2>
<p>JavaのGenericsでは、型パラメーターは最終的にバイトコードになったら消えて<code>Object</code> になってしまって、Generic型からその型パラメーターで示された型を実際に使う側がキャストして使うというものなんですね。だからこのようなコードに対して:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;();</span>
    <span class="n">l</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">Integer</span> <span class="n">a</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>
<p>このようなバイトコードが出力されます:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">Compiled from &quot;Main.java&quot;
class Main extends java.lang.Object{
Main();
  Code:
   0:   aload_0
   1:   invokespecial   #1; //Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V
   4:   return

public static void main(java.lang.String[]);
  Code:
   0:   new     #2; //class java/util/ArrayList
   3:   dup
   4:   invokespecial   #3; //Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V
   7:   astore_1
   8:   aload_1
   9:   iconst_1
   10:  invokestatic    #4; //Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
   13:  invokeinterface #5,  2; //InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z
   18:  pop
   19:  aload_1
   20:  iconst_0
   21:  invokeinterface #6,  2; //InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;
   26:  checkcast       #7; //class java/lang/Integer
   29:  astore_2
   30:  return

}
</code></pre></div>
<p><code>ArrayList</code> の型パラメーターが消えていて、要素を取り出すときに <code>checkcast</code>でキャストしてますね。</p>
<h2>総称配列を作るときのエラー・警告</h2>
<p>例えば次のようなコードはgeneric array createionエラーになります:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;[]</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;[</span><span class="mi">10</span><span class="o">];</span>
</code></pre></div>
<p>これは配列をアロケートするときに、バイトコードの中で型情報が必要になるのに、<code>ArrayList&lt;Integer&gt;</code> は(バイトコードレベルでは)実際は存在せず、<code>ArrayList</code> が存在しているからです。</p>

<p>なので次のようなコードを書きます:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;[]</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">[</span><span class="mi">10</span><span class="o">];</span>
<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;[]</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;?&gt;[</span><span class="mi">10</span><span class="o">];</span>
</code></pre></div>
<p>しかし今度はunchecked conversionの警告が起きます。Javaが型チェックをするときは、 <code>ArrayList</code> と <code>ArrayList&lt;Integer&gt;</code> は違う型ですから。</p>
<h2>追記</h2>
<p>generic array creationがなぜ禁止なのかきちんと理解してなかった。</p>

<p>Generic型の配列が作れると仮定しましょう。次のコードはエラー・警告なしでコンパイル出来ます:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">ArrayList</span><span class="o">[]</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;[</span><span class="mi">10</span><span class="o">];</span>
<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stringArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
<span class="n">stringArray</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;Some String&quot;</span><span class="o">);</span>
<span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">stringArray</span><span class="o">;</span>

<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">intArray</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
<span class="n">Integer</span> <span class="n">intObj</span> <span class="o">=</span> <span class="n">intArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// ClassCastException occur!</span>
</code></pre></div>
<p>一方でGeneric型以外の配列の場合は、次のようになります:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">Number</span><span class="o">[]</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">[</span><span class="mi">10</span><span class="o">];</span>
<span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// ArrayStoreException occur!</span>
</code></pre></div>
<p>Generic型以外の配列の場合、型の違うオブジェクトの参照を配列に代入しようとすると、 <code>ArrayStoreException</code> が発生しますが、Generic型の配列の場合はその例外は発生せずに、値を取り出したときに <code>ClassCastException</code> が発生するようになります。これがGeneric型の配列が作れない理由のようです。</p>

<p>また、総称配列が作れなくても、上のコードは次のように書き換えると、unchecked conversion warningが出るけれども、 <code>ClassCastException</code> が発生するように実行することが出来ます:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="n">ArrayList</span><span class="o">[]</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">[</span><span class="mi">10</span><span class="o">];</span>
<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">stringArray</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
<span class="n">stringArray</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&quot;Some String&quot;</span><span class="o">);</span>
<span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">stringArray</span><span class="o">;</span>

<span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">intArray</span> <span class="o">=</span> <span class="n">list</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span> <span class="c1">// unchecked conversion warning</span>
<span class="n">Integer</span> <span class="n">intObj</span> <span class="o">=</span> <span class="n">intArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// ClassCastException occur!</span>
</code></pre></div>
<p>次のように書き換えると、今度はきちんと <code>list[0] = stringArray</code> のところで型エラーを起こしてくれます:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">ArrayList&lt;Integer&gt;[] list = new ArrayList[10]; // unchecked conversion warning
ArrayList&lt;String&gt; stringArray = new ArrayList&lt;String&gt;();
stringArray.add(&quot;Some String&quot;);
list[0] = stringArray; // Incompatible types error

ArrayList&lt;Integer&gt; intArray = list[0];
Integer intObj = intArray.get(0);
</code></pre></div><h2>配列は使ってはいけない</h2>
<p>総称配列のエラー・警告はJavaレベルの型とJVMレベルの型が一致していないことが原因に見えますが、実は配列を使わなければこのような問題は回避されるようです。(僕はGenericsによってJavaとJVMの型が一致しなくなったこともなんかアレな気がするんですが)</p>

<p>また、配列がcovariantなのもまた変なエラーの原因となるので、配列さえ使わなければ……というのがかなり前から言われているようです。</p>

  </div>
</div>
<div id='comments'>
  <div id='disqus_thread'></div>
  <script>
    var disqus_shortname = 'draftcode-github-com';
    
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
  </noscript>
</div>

    </div>
    <div id='disclaimer'>
      Disclaimer: The opinions stated here are my own, not necessarily those of my company.
    </div>
  </body>
</html>
