<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
    <title>RoboGuiceのInjectExtraを使うとテストがしにくくなる件について</title>
    <meta content='draftcode' name='author'>
    <meta content='YjRoDozMq67s3NKiyM6spjwqnSVihlZ11ur-OgfZCU0' name='google-site-verification'>
    <link href='/css/main.css' rel='stylesheet'>
    <link href='/atom.xml' rel='alternate' title='Atom' type='application/atom+xml'>
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Economica' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <div id='site-title-short'>
      <div class='svg' id='links'>
        <a href='/pages/about.html' id='about'>About</a>
        <a class='fc-webicon twitter' href='http://twitter.com/draftcode'>Twitter</a>
        <a class='fc-webicon github' href='http://github.com/draftcode'>GitHub</a>
        <a class='fc-webicon googleplus' href='https://plus.google.com/107177890582465029754?rel=author'>Google+</a>
        <a class='fc-webicon rss' href='/atom.xml' rel='alternate'>Atom feed</a>
      </div>
      <h1>
        <a href='/'>draftcode.github.io</a>
      </h1>
    </div>
    <div id='content'>
      <div id='article'>
  <div id='content_title'>
    <h1>RoboGuiceのInjectExtraを使うとテストがしにくくなる件について</h1>
  </div>
  <div id='posted_date'>
    Posted on 2012-09-23
  </div>
  <div id='content_body'>
    <p>RoboGuiceのInjectなんとか系は記述量が減ってテストもしやすくなって便利ですが、残念ながらInjectExtraだけはイマイチと言わざるを得ません。使っているバーションは、RoboGuice 1.1.2とGuice 2.0 no-aopで、Robolectricでテストを書いたりしています。もしかしたら、RoboGuice 2.0で解消されているのかも知れません。</p>
<h2>問題背景</h2>
<p>まず、実機で動くコードでは、 <code>RoboActivity.onCreate()</code> の中でInjectionが行われます。このとき、 <code>InjectView</code> 以外のフィールドがInjectされます。その中には当然 <code>InjectExtra</code> も入っていますので、ここでそのInjectionのContextである ActivityからIntentがとり出されて、Extraが入ります:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SOME_EXTRA_ID</span> <span class="o">=</span> <span class="s">&quot;SOME_EXTRA_ID&quot;</span><span class="o">;</span>
<span class="nd">@InjectExtra</span><span class="o">(</span><span class="n">SOME_EXTRA_ID</span><span class="o">)</span>
<span class="kt">int</span> <span class="n">someExtra</span><span class="o">;</span>
</code></pre></div>
<p>次に、テストコードの中で、クラス中にテスト対象のActivityをInjectしているとします。このとき、Activityに <code>InjectExtra</code> が入っているとInjectionに失敗してしまいます。失敗する理由としては、次の2つが挙げられます。</p>

<ol>
<li>Injectionを行うActivityにIntentがセットされていないこと。</li>
<li>Injectionを行うScopeが <code>ContextScope</code> ではないこと。特に、Activityの<code>ContextScope</code> ではないこと。</li>
</ol>
<h2>解決策</h2>
<p>この2つを回避するために、それなりに現実的な方法で対処をしてみようと試みましたが、根本的に実際に実機で動くときのコードとテスト中のコードでInjectionタイミングが違うことが問題なので、上手く行きませんでした。Activityはどこかほかのオブジェクトの中でInjectされることを、あまり想定していないのです。</p>

<p>大掛かりな解決策としては、 <code>ExtrasListener</code> と <code>ContextScope</code> を変更して、<code>InjectExtra</code> が処理されるタイミングを変更するというものがありますが、そこまでして <code>InjectExtra</code> を使いたくありません。</p>

<p>大掛かりな解決策を取らずに <code>InjectExtra</code> を利用したActivityに対してテストを書くのであれば、ActivityはテストコードでのInjecされないようにして、 <code>setUp</code>の中で手動Injectするしかありません。その手動Injectを行う場合には、自分でその Activityの <code>ContextScope</code> を生成して、その中で <code>injectMembers</code> を行う必要があります。この方法を取ると、一見、テストコード中の <code>InjectView</code> が効かなくなりそうですが、どうやら <code>ContextScope</code> のスタックがきちんとしているのか、そのActivityが <code>setContentView</code> をしたときに、きちんとInjectionされます:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TEST_EXTRA</span> <span class="o">=</span> <span class="mi">42</span><span class="o">;</span>

<span class="nd">@Inject</span>
<span class="n">Injector</span> <span class="n">injector</span><span class="o">;</span>
<span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">myButton</span><span class="o">)</span>
<span class="n">Button</span> <span class="n">myButton</span><span class="o">;</span>

<span class="kd">private</span> <span class="n">MyActivity</span> <span class="n">activity</span><span class="o">;</span>

<span class="nd">@Before</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">activity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyActivity</span><span class="o">();</span>
    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">MyActivity</span><span class="o">.</span><span class="na">SOME_EXTRA_ID</span><span class="o">,</span> <span class="n">TEST_EXTRA</span><span class="o">);</span>
    <span class="n">activity</span><span class="o">.</span><span class="na">setIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>

    <span class="n">ContextScope</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ContextScope</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">scope</span><span class="o">.</span><span class="na">enter</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
    <span class="n">injector</span><span class="o">.</span><span class="na">injectMembers</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
    <span class="n">scope</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>
<p><code>ContextScope</code> 周りは、RoboGuice 2.0では多少改善されているのは確認できました。 <code>RoboGuice.injectMembers(Context, T)</code> というメソッドが存在するのが確認できました。</p>

<p>もうひとつの解決策は、もう <code>InjectExtra</code> を使わないという方法で、自分はもうこっちの方法でいいかなと思っています。</p>

  </div>
</div>
<div id='comments'>
  <div id='disqus_thread'></div>
  <script>
    var disqus_shortname = 'draftcode-github-com';
    
    (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
  <noscript>
    Please enable JavaScript to view the
    <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a>
  </noscript>
</div>

    </div>
    <div id='disclaimer'>
      Disclaimer: The opinions stated here are my own, not necessarily those of my company.
    </div>
  </body>
</html>
