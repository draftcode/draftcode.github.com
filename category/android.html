<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>draftcode.github.io</title>
    <meta name="author" content="draftcode">
    <meta name="google-site-verification" content="YjRoDozMq67s3NKiyM6spjwqnSVihlZ11ur-OgfZCU0">

    <link href="../theme/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <link href="../theme/print.css" media="print" rel="stylesheet" type="text/css" />
    <!--[if IE]>
    <link href="../theme/ie.css" media="screen, projection" rel="stylesheet" type="text/css" />
    <![endif]-->

    <link rel="alternate" type="application/atom+xml" title="Atom" href="../atom.xml">
    <link href='http://fonts.googleapis.com/css?family=Economica' rel='stylesheet'>
  </head>

  <body>
    <h1 id="site-title"><a href="..">draftcode.github.io</a></h1>

    <div id="content">
      

<div class='article'>
  <div class="content-title">
    <h1><a href="../2012/09/23/25036f39-d55f-45b2-97ca-19460353c847.html">RoboGuiceのInjectExtraを使うとテストがしにくくなる件について</a></h1>
  </div>
  <dl class="metadata">
    <dt>Posted</dt>
    <dd>2012/09/23</dd>
  </dl>

  <div class="content-body section"><p>RoboGuiceのInjectなんとか系は記述量が減ってテストもしやすくなって便利ですが、残念ながらInjectExtraだけはイマイチと言わざるを得ません。使っているバーションは、RoboGuice 1.1.2とGuice 2.0 no-aopで、Robolectricでテストを書いたりしています。もしかしたら、RoboGuice 2.0で解消されているのかも知れません。</p>
<div class="section" id="id1">
<h2>問題背景</h2>
<p>まず、実機で動くコードでは、<tt class="docutils literal">RoboActivity.onCreate()</tt>の中でInjectionが行われます。このとき、<tt class="docutils literal">InjectView</tt>以外のフィールドがInjectされます。その中には当然<tt class="docutils literal">InjectExtra</tt>も入っていますので、ここでそのInjectionのContextである
ActivityからIntentがとり出されて、Extraが入ります:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SOME_EXTRA_ID</span> <span class="o">=</span> <span class="s">&quot;SOME_EXTRA_ID&quot;</span><span class="o">;</span>
<span class="nd">@InjectExtra</span><span class="o">(</span><span class="n">SOME_EXTRA_ID</span><span class="o">)</span>
<span class="kt">int</span> <span class="n">someExtra</span><span class="o">;</span>
</pre></div>
<p>次に、テストコードの中で、クラス中にテスト対象のActivityをInjectしているとします。このとき、Activityに<tt class="docutils literal">InjectExtra</tt>が入っているとInjectionに失敗してしまいます。失敗する理由としては、次の2つが挙げられます。</p>
<ol class="arabic simple">
<li>Injectionを行うActivityにIntentがセットされていないこと。</li>
<li>Injectionを行うScopeが<tt class="docutils literal">ContextScope</tt>ではないこと。特に、Activityの<tt class="docutils literal">ContextScope</tt>ではないこと。</li>
</ol>
</div>
<div class="section" id="id2">
<h2>解決策</h2>
<p>この2つを回避するために、それなりに現実的な方法で対処をしてみようと試みましたが、根本的に実際に実機で動くときのコードとテスト中のコードでInjectionタイミングが違うことが問題なので、上手く行きませんでした。Activityはどこかほかのオブジェクトの中でInjectされることを、あまり想定していないのです。</p>
<p>大掛かりな解決策としては、<tt class="docutils literal">ExtrasListener</tt>と<tt class="docutils literal">ContextScope</tt>を変更して、<tt class="docutils literal">InjectExtra</tt>が処理されるタイミングを変更するというものがありますが、そこまでして<tt class="docutils literal">InjectExtra</tt>を使いたくありません。</p>
<p>大掛かりな解決策を取らずに<tt class="docutils literal">InjectExtra</tt>を利用したActivityに対してテストを書くのであれば、ActivityはテストコードでのInjecされないようにして、<tt class="docutils literal">setUp</tt>の中で手動Injectするしかありません。その手動Injectを行う場合には、自分でそのActivityの<tt class="docutils literal">ContextScope</tt>を生成して、その中で<tt class="docutils literal">injectMembers</tt>を行う必要があります。この方法を取ると、一見、テストコード中の<tt class="docutils literal">InjectView</tt>が効かなくなりそうですが、どうやら<tt class="docutils literal">ContextScope</tt>のスタックがきちんとしているのか、そのActivityが<tt class="docutils literal">setContentView</tt>をしたときに、きちんとInjectionされます:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">TEST_EXTRA</span> <span class="o">=</span> <span class="mi">42</span><span class="o">;</span>

<span class="nd">@Inject</span>
<span class="n">Injector</span> <span class="n">injector</span><span class="o">;</span>
<span class="nd">@InjectView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">myButton</span><span class="o">)</span>
<span class="n">Button</span> <span class="n">myButton</span><span class="o">;</span>

<span class="kd">private</span> <span class="n">MyActivity</span> <span class="n">activity</span><span class="o">;</span>

<span class="nd">@Before</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">activity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyActivity</span><span class="o">();</span>
    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">();</span>
    <span class="n">intent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">MyActivity</span><span class="o">.</span><span class="na">SOME_EXTRA_ID</span><span class="o">,</span> <span class="n">TEST_EXTRA</span><span class="o">);</span>
    <span class="n">activity</span><span class="o">.</span><span class="na">setIntent</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>

    <span class="n">ContextScope</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">injector</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">ContextScope</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">scope</span><span class="o">.</span><span class="na">enter</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
    <span class="n">injector</span><span class="o">.</span><span class="na">injectMembers</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
    <span class="n">scope</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<p><tt class="docutils literal">ContextScope</tt>周りは、RoboGuice 2.0では多少改善されているのは確認できました。<tt class="docutils literal">RoboGuice.injectMembers(Context, T)</tt>というメソッドが存在するのが確認できました。</p>
<p>もうひとつの解決策は、もう<tt class="docutils literal">InjectExtra</tt>を使わないという方法で、自分はもうこっちの方法でいいかなと思っています。</p>
</div>
</div>
</div>

 
<div class="pagination">
  <ul>
        <li class="prev disabled">&larr; Previous</li>
    
            <li class="active">1</li>
        
        <li class="next disabled">&rarr; Next</li>
      </ul>
</div>

 
    </div>

    <div id="footer">
      <div id="footer-container">
        <div id="about">
          <h2>About the author</h2>
          <a href="../pages/about.html"><img src="../static/images/draftcode.png" /></a>
          <p>東京で情報工学を専攻している大学院生です。<br />プログラミング言語の研究をしています。<br /></p>
          <p>詳しくは<a href="../pages/about.html">こちら</a></p>
        </div>

        <div id="site">
          <h2>Site</h2>
          <ul>
            <li><a href="../archives.html">Archives</a>
            <li><a href="../atom.xml" rel="alternate">Atom feed</a></li>
          </ul>
        </div>

        <div id="social">
          <h2>Social</h2>
          <ul>
                        <li class="social"><a href="http://twitter.com/#!/draftcode">Twitter</a></li>            <li class="social"><a href="http://github.com/draftcode">GitHub</a></li>            <li class="social"><a href="https://plus.google.com/107177890582465029754?rel=author">Google+</a></li>          </ul>
        </div>
      </div>
      <p id="disclaimer">Disclaimer: ここで述べられていることは私の個人的な意見に基づくものであり､私の雇用者には一切の関係はありません｡ </p>
    </div>
  </body>
</html>